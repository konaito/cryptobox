# EIP-7702 概要まとめ

## 1. EIP-7702とは
**EIP-7702**は、Ethereum上の**Externally Owned Account（EOA）**にスマートコントラクト的な機能を一時的・または恒久的に付与することを目的とした改善提案です。EOAは通常、単純な署名によるトランザクション送信やスマートコントラクト呼び出しが可能ですが、複数のトランザクションをまとめて実行（バッチ処理）したり、他アドレスのガス代を支払ったりする機能はありません。  
EIP-7702では、**EOAの制限を補う**ために、新しいトランザクション形式を導入し、アカウントコードを設定したり、一時的にスマートコントラクト的な動作を可能にしたりします。

---

## 2. 従来の問題と目的

1. **バッチトランザクションの実行**  
   多くの分散型アプリケーション（DEXなど）で必要となる「1回目に承認（approve）、2回目にトークンを送る（transfer）」のような複数回の操作を、**1つのトランザクションにまとめたい**という需要があります。

2. **ガス代のスポンサー（代わり払い）**  
   他のアカウントがガス代を肩代わりして、ユーザー体験を向上させたい場合があります。

3. **権限分割（サブキー）**  
   メインの秘密鍵を使わずに、限定的な操作のみ可能なサブキーによる権限管理を行いたい、というケースがあります。

EIP-7702は、これらのニーズに応える**小回りの利くアカウント拡張**を実現することを目標にしています。

---

## 3. 仕組みの概要

### 3.1 新しいトランザクション形式
- **Set Code Transaction**（EIP-2718互換）という新しい型を追加し、`authorization_list`を持ちます。
- この`authorization_list`に含まれる各要素（tuple）によって、**「どのアドレスにどのコードを適用するか」**などを指定します。

### 3.2 contract_code（または delegation designator）の設定
- トランザクション内で、指定された**EOAに対して「一時的／永久的なコード」をセット**します。  
- 実際のバイトコードを直接注入するのではなく、**特殊なフォーマット（0xef0100 + 対象アドレスなど）**で格納し、**その先のアドレスに配置されたコード**を参照して実行させるイメージです。

### 3.3 実行と終了
1. **実行開始時**  
   - まず送信元（sender）のnonceが更新される。  
   - `authorization_list`内の各要素を順に検証し、該当EOAにコード設定を行う。  
   - コードは**「元のEOAのアドレス＝authorityアドレス」に対して設定**される。

2. **トランザクション中の処理**  
   - EOAであっても、設定されたコードを**“スマートコントラクト的”**に呼び出し、複数の操作をまとめたり、ガス代の肩代わりを行ったりできる。

3. **トランザクション完了後**  
   - EOAは一時的なコード指定を持つ場合は元に戻るか、指定方法次第で永久的にコードを保持する可能性もある（仕様上は「0x0指定で完全消去」なども可能）。

---

## 4. 具体的なユースケース例

1. **バッチ処理**  
   EOAが、ERC-20の`approve → transferFrom`といった操作を1回のトランザクションにまとめて実行できる。  
2. **スポンサー（ガス代負担）**  
   別アカウントが用意したスマートコントラクトコードをEOAに割り当て、**代わりにガス代を支払う**仕組みをトランザクション内で完結させる。  
3. **権限縮小やサブキーの管理**  
   複雑なロジック（例：1日あたり送金額制限、特定コントラクトとしかやり取りできない等）をスマートコントラクト的に実装し、EOAに一時的に持たせる。

---

## 5. セキュリティと注意点

1. **署名と再利用（リプレイ）対策**  
   - `authorization_list`は、EIP-2準拠のECDSA検証で署名を確認し、nonce管理なども行って不正再利用を防ぐ。
2. **トランザクション処理の複雑化**  
   - 一時的にEOAがスマートコントラクトと同等の動きをするため、**mempool管理**や**nonce**の整合に注意が必要。
3. **コード差し替えとストレージ**  
   - アカウントにコードを付与・変更する際、**意図せぬストレージ衝突**や初期化レースなどに留意が必要。
4. **`tx.origin` の扱い**  
   - これまでは「`tx.origin == msg.sender` はトップレベルのEOAのみ」が常だったが、EIP-7702でEOA内部が`DELEGATECALL`されると、**深いコールレイヤーでも `msg.sender == tx.origin` が成立するケースが生じる**。  
   - 古いコントラクトの**再入 (reentrancy) 対策や`tx.origin`依存ロジック**が壊れる可能性があるため注意。

---

## 6. 実装・採用見通し

- **コミュニティでの支持**  
  EIP-7702は、以前のEIP-3074や同様の提案が抱えていた制限やセキュリティ懸念を解消する狙いがあり、注目度が高い。  
- **Ethereumのアップグレードとの絡み**  
  一部で「2024年後半予定のアップグレード（例：Pectraアップグレードなど）で実装されるかもしれない」と言われているが、現時点（草案）では確定ではない。

---

## 7. まとめ

- **EIP-7702**は、EOAに**一時的・恒久的なスマートコントラクト機能**を付与できるようにする提案で、**バッチ処理・ガス代スポンサー・権限管理**などの需要に応える仕組み。  
- トランザクション形式を拡張し、独自の`authorization_list`で**署名検証とコード指定**を行う。  
- 実現すれば、**EOAの使い勝手**（複数操作の一括実行やコスト負担の調整など）が格段に向上するが、一方で**セキュリティと互換性**には入念な設計が必要。  
- 実装に向けた議論は進行中で、正式採用されるかは**まだ未定**。  

本EIPは、将来の**フル・アカウントアブストラクション**（AA）への道を開く一手段とも見なされており、今後も議論と改良が期待されています。
